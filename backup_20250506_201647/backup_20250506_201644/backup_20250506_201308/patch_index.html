#!/bin/bash
set -e  # Exit on any error

# The frontend HTML file
INDEX_FILE="github-frontend-build/index.html"

# Check if the file exists
if [ ! -f "$INDEX_FILE" ]; then
  echo "Error: $INDEX_FILE does not exist"
  exit 1
fi

echo "Patching $INDEX_FILE to fix API URL..."

# Create patch script
cat > github-frontend-build/assets/api-patch.js << EOF
// API URL patch script
(function() {
  console.log("API URL patch script running...");
  
  // Override fetch to redirect API calls
  const originalFetch = window.fetch;
  window.fetch = function(url, options) {
    if (typeof url === 'string' && url.includes('localhost:5000')) {
      const newUrl = url.replace('http://localhost:5000/', window.location.origin + '/');
      console.log('Redirecting API call from', url, 'to', newUrl);
      url = newUrl;
    }
    return originalFetch.call(this, url, options);
  };
  
  console.log("API URL patch applied");
})();
EOF

# Add the script to index.html before the closing head tag
sed -i.bak 's/<\/head>/<script src="\/assets\/api-patch.js"><\/script>\n  <\/head>/' "$INDEX_FILE"

echo "Patch applied successfully!"